<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Indemind OV580 深度相机 Viewer</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
         background: #1a1a2e; color: #eee; min-height: 100vh; }
  .header { text-align: center; padding: 16px; background: #16213e; }
  .header h1 { font-size: 1.4rem; font-weight: 600; }

  .streams { display: flex; justify-content: center; gap: 16px;
             padding: 16px; flex-wrap: wrap; }
  .stream-box { background: #0f3460; border-radius: 8px; overflow: hidden;
                display: flex; flex-direction: column; align-items: center; }
  .stream-box h3 { padding: 8px 16px; font-size: 0.9rem; color: #a0d2db; }
  .stream-box img { width: 640px; height: 400px; object-fit: contain;
                    background: #000; display: block; }

  .controls { display: flex; justify-content: center; align-items: center;
              gap: 16px; padding: 16px; flex-wrap: wrap; }
  .btn { padding: 8px 24px; border: none; border-radius: 6px; cursor: pointer;
         font-size: 0.95rem; font-weight: 500; transition: background 0.2s; }
  .btn-start { background: #27ae60; color: #fff; }
  .btn-start:hover { background: #2ecc71; }
  .btn-stop { background: #c0392b; color: #fff; }
  .btn-stop:hover { background: #e74c3c; }

  .alpha-ctrl { display: flex; align-items: center; gap: 8px; }
  .alpha-ctrl input[type="range"] { width: 160px; }
  .alpha-ctrl span { min-width: 40px; text-align: center; }

  .status-bar { text-align: center; padding: 8px; font-size: 0.85rem; color: #888; }
  .status-bar .dot { display: inline-block; width: 10px; height: 10px;
                     border-radius: 50%; margin-right: 6px; vertical-align: middle; }
  .dot-on { background: #27ae60; }
  .dot-off { background: #c0392b; }
</style>
</head>
<body>

<div class="header">
  <h1>Indemind OV580 深度相机 Viewer</h1>
</div>

<div class="streams">
  <div class="stream-box">
    <h3>左目画面</h3>
    <img id="img-left" alt="左目画面">
  </div>
  <div class="stream-box">
    <h3>深度叠加</h3>
    <img id="img-overlay" alt="深度叠加">
  </div>
</div>

<div class="controls">
  <button class="btn btn-start" id="btn-start" onclick="doStart()">启动</button>
  <button class="btn btn-stop" id="btn-stop" onclick="doStop()">停止</button>
  <div class="alpha-ctrl">
    <span>透明度:</span>
    <input type="range" id="alpha-slider" min="0" max="100" value="50"
           oninput="updateAlpha(this.value)">
    <span id="alpha-val">50%</span>
  </div>
</div>

<div class="status-bar" id="status-bar">
  <span class="dot dot-off" id="status-dot"></span>
  状态: 未连接
</div>

<script>
const imgLeft    = document.getElementById('img-left');
const imgOverlay = document.getElementById('img-overlay');
const statusBar  = document.getElementById('status-bar');
const statusDot  = document.getElementById('status-dot');
const alphaSlider = document.getElementById('alpha-slider');
const alphaVal   = document.getElementById('alpha-val');

function setStreams(on) {
  if (on) {
    imgLeft.src    = '/stream';
    imgOverlay.src = '/stream/overlay';
  } else {
    imgLeft.src    = '';
    imgOverlay.src = '';
  }
}

async function doStart() {
  const resp = await fetch('/api/start', { method: 'POST' });
  const data = await resp.json();
  if (data.success) {
    setStreams(true);
  } else {
    alert('启动失败: ' + (data.error || '未知错误'));
  }
}

async function doStop() {
  setStreams(false);
  await fetch('/api/stop', { method: 'POST' });
}

async function updateAlpha(val) {
  alphaVal.textContent = val + '%';
  await fetch('/api/config', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ alpha: val / 100 })
  });
}

async function pollStatus() {
  try {
    const resp = await fetch('/api/status');
    const s = await resp.json();
    const running = s.running;
    statusDot.className = 'dot ' + (running ? 'dot-on' : 'dot-off');
    statusBar.innerHTML =
      `<span class="dot ${running ? 'dot-on' : 'dot-off'}"></span>` +
      `状态: ${running ? '已连接' : '未连接'}` +
      ` &nbsp; FPS: ${s.fps}` +
      ` &nbsp; ${s.resolution}` +
      ` &nbsp; 透明度: ${Math.round(s.alpha * 100)}%`;
  } catch (e) { /* ignore */ }
}

setInterval(pollStatus, 2000);
pollStatus();
</script>

</body>
</html>
